<%@ page language="java" contentType="text/html; charset=UTF-8"	pageEncoding="UTF-8"%><%	String path = request.getContextPath();	String basePath = request.getScheme() + "://"			+ request.getServerName() + ":" + request.getServerPort()			+ path + "/";%><%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%><%@ taglib prefix="form" uri="http://www.springframework.org/tags/form"%><!DOCTYPE html><html><head><meta charset=utf-8><link rel="shortcut icon" href="./pages/css/images/webicon.png"	type="image/x-icon" /><meta name="viewport"	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" /><meta content="yes" name="apple-mobile-web-app-capable" /><meta content="telephone=no" name="format-detection" /><meta content="black" name="apple-mobile-web-app-status-bar-style" /><title>围栏报警</title><link rel="stylesheet" type="text/css"	href="./pages/css/Electronic-alarm.css" /><link rel="stylesheet" type="text/css"	href="<%=basePath%>pages/css/base1.css" /><link href="./pages/css/bootstrap.css" rel="stylesheet"><link href="./pages/zTreeStyle/zTreeStyle.css" rel="stylesheet" /><script src="./pages/My97DatePicker/WdatePicker.js"></script><script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script><script src="http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script><script src="./pages/js/jquery-1.4.4.min.js" type="text/javascript"></script><script src="./pages/js/jquery.ztree.core-3.5.min.js"></script><script src="./pages/js/jquery.ztree.excheck.min.js"></script><script src="./pages/js/jquery.ztree.exedit.min.js"></script><script type="text/javascript"	src="http://api.map.baidu.com/api?v=2.0&ak=Vd7Dc0nXYFLcVfLWSqZitEXk"></script><script type="text/javascript"	src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script><script type="text/javascript"	src="http://api.map.baidu.com/library/GeoUtils/1.2/src/GeoUtils.js"></script><script>	var setting = {		check : {			enable : true		},		data : {			simpleData : {				enable : true			}		},		callback : {			onClick : zTreeOnClick		}	};	function zTreeOnClick(event, treeId, treeNode) {		$("#manage-Monitor-work-map-id").load("manage-Monitor-Realtime.html");		alert(treeNode.flag + "., " + treeNode.name, +"," + treeNode.id);	};	var data = '${sectorDataWithCar}';	var zNodes = eval(data);	var code;	function setCheck() {		var zTree = $.fn.zTree.getZTreeObj("menuTree"), py = "p", sy = "s", pn = "p", sn = "s", type = {			"Y" : py + sy,			"N" : pn + sn		};		zTree.setting.check.chkboxType = type;		showCode('setting.check.chkboxType = { "Y" : "' + type.Y + '", "N" : "'				+ type.N + '" };');	}	function showCode(str) {		if (!code)			code = $("#code");		code.empty();		code.append("<li>" + str + "</li>");	}	$(document).ready(function() {		$.fn.zTree.init($("#menuTree"), setting, zNodes);		setCheck();		$("#py").bind("change", setCheck);		$("#sy").bind("change", setCheck);		$("#pn").bind("change", setCheck);		$("#sn").bind("change", setCheck);	});</script></head><body>	<div class="manage-Monitor-title">		<div class="manage-Monitor-title-date">			<img src="<%=basePath%>pages/img/date-logo.png" width="25px"				height="25px"				style="margin-left: 15px; margin-right: 20px; float: left"></img>			<div				style="width: 250px; height: 30px; padding-left: 30px; font-size: 20px; color: #FFF">				<script>					var now = new Date()					document.write(1900+now.getYear()+"年"+(now.getMonth()+1)+"月"+(now.getDate()+"日"))                </script>			</div>		</div>		<div class="manage-Monitor-title-logo">			<img src="<%=basePath%>pages/img/login-logo-jt.png" width="10%"				height="50%"				style="margin-left: 65px; margin-top: 3%; margin-right: 20px; float: left;"></img>			<img src="<%=basePath%>pages/img/login-title-jt.png" width="60%"				height="50%" style="margin-top: 5%;"></img>		</div>		<div class="manage-Monitor-title-handle">			<div				style="font-size: 16px; height: 60%; width: 60%; float: left; margin-top: 2%;">				<a href="<%=basePath%>pages/fleetmanage-main.jsp"					style="font-size: 16px; width: 35%; float: left; text-align: right;">返回首页</a>				<p id="username-value"					style="font-size: 14px; width: 25%; float: right; color: #666">					${username}</p>				<p id="username"					style="font-size: 16px; width: 40%; float: right; text-align: right;">					当前用户:</p>			</div>			<button class="btn-reflash" id="refresh"				onclick="javascript:location.reload()">刷新</button>			<button id="cancel" class="btn-exit">退出</button>		</div>	</div>	<div class="manage-Monitor-left-menu-title"		id="manage-Monitor-left-menu-title-id">		<div id="manage-Monitor-left-menu-title-panel-group">			<div class="panel-group" id="accordion" role="tablist"				aria-multiselectable="true" style="padding: 10px 0;">				<div class="panel panel-default zl-panel" style="background: #3CC">					<div id="collapseOne" class="panel-collapse collapse in"						role="tabpanel" aria-labelledby="headingOne"						style="background: #bfd9f6">						<div id="collapseOneBody" class="panel-body"							style="height: 300px; overflow-y: auto; overflow-x: hidden;">							<ul id="menuTree" class="ztree">							</ul>						</div>					</div>				</div>			</div>		</div>	</div>	<div class="manage-Monitor-right-work-wap"		id="manage-Monitor-right-work-wap-id">		<button id="manage-Monitor-right-work-data-MenuDisplay-btn"			onClick="showMeaun()">显示目录</button>		<div class="manage-Monitor-right-work-data">			<nav class="manage-Monitor-right-work-navigation-nav">				<ul>					<li><a href="sector_allwithcar?sectorId=1">							<div								style="width:30%;height:45%;margin-top:10%;margin-left:35%;background:url(<%=basePath%>pages/img/i-1.png);background-size:100% 100%;	background-repeat: no-repeat;"></div>							<em style="width: 100%; height: 30%; color: #FFF;">车辆监控</em>					</a></li>					<li><a href="driveLog_all?pageNow=1">							<div								style="width:30%;height:45%;margin-top:10%;margin-left:35%;background:url(<%=basePath%>pages/img/i-2.png);background-size:100% 100%;	background-repeat: no-repeat;"></div>							<em style="width: 100%; height: 40%; color: #FFF;">行程纪录</em>					</a></li>					<li class="active"><a href="crawlWarn_manage?pageNow=1"						onclick="javascript:document.getElementById('sectorinfo').value = 0">							<div								style="width:30%;height:45%;margin-top:10%;margin-left:35%;background:url(<%=basePath%>pages/img/i-3.png);background-size:100% 100%;	background-repeat: no-repeat;"></div>							<em style="width: 100%; height: 30%; color: #FFF;">围栏监控</em>					</a></li>					<li><a href="crawl_allwithcar"						onclick="javascript:document.getElementById('sectorinfo').value = 0">							<div								style="width:30%;height:45%;margin-top:10%;margin-left:35%;background:url(<%=basePath%>pages/img/i-11.png);background-size:100% 100%;	background-repeat: no-repeat;"></div>							<em style="width: 100%; height: 30%; color: #FFF;">设置围栏</em>					</a></li>				</ul>			</nav>		</div>		<div class="manage-Monitor-right-work"			id="manage-Monitor-right-work-id">			<div class="set_Electronic_menu">				<div class="set_Electronic_menu_seach">					<form:form id="form" commandName="crawlinfo"						action="crawlWarn_manage" method="post">						<!-- 代表当前属于第几页 -->						<input id="pageNow" type="hidden" name="pageNow"							value="${crawlPage.pageNow}">						<form:input id="crawlname" class="input_seach" path="crawlname" />						<button class="btn_seach" type="submit">检索</button>					</form:form>				</div>				<div class="set_Electronic_menu_list">					<ul>						<c:forEach items="${crawlPage.list}" var="crawlinfo">							<li onClick="trOnclick('${crawlinfo.crawlname}')">								<div>									<p>${crawlinfo.crawlname}</p>								</div>							</li>						</c:forEach>					</ul>				</div>				<div class="set_Electronic-alarm-menu-work-end">					<div class="set_Electronic-alarm-menu-work-page">						<p style="width: 100%; height: 20%; text-align: center">第							${crawlPage.pageNow} 页; 共 ${crawlPage.totalPageCount} 页</p>						<div class="set_Electronic_menu-wor-page-check">							<a id="first" href="#">首页</a> <a id="last" href="#">上一页</a> <a								id="next" href="#">下一页</a> <a id="end" href="#">尾页</a>						</div>					</div>				</div>			</div>			<div class="manage-Monitor-work-map" id="manage-Monitor-work-map-id">				<div class="manage-Monitor-work-map-car-type">					<ul>						<li><span style="font-size: 14px;">行驶</span>							<p								style="background: #393; width: 15px; height: 15px; float: left; margin: 4px"></p>							<span>5辆</span></li>						<li><span style="font-size: 14px;">停车</span>							<p								style="background: #F00; width: 15px; height: 15px; float: left; margin: 4px"></p>							<span>5辆</span></li>						<li><span style="font-size: 14px;">报警</span>							<p								style="background: #0F0; width: 15px; height: 15px; float: left; margin: 4px"></p>							<span>5辆</span></li>						<li><span style="font-size: 14px;">离线</span>							<p								style="background: #999; width: 15px; height: 15px; float: left; margin: 4px"></p>							<span>5辆</span></li>					</ul>				</div>				<div style="height: 50%; font-size: 12px" id="map"></div>				<div class="set_Electronic_alarm">					<table class="table table-bordered">						<thead							style="background-image: url(<%=basePath%>pages/img/end-page-bg.png)">							<tr>								<th>车牌号</th>								<th>状态</th>								<th>报警时间</th>							</tr>						</thead>						<tbody id="tb">							<c:forEach items="${warnList}" var="warnInfo">								<tr>									<th>${warnInfo.plateNumber}</th>									<th><c:if test="${warnInfo.warntype==6}">驶出报警</c:if> <c:if											test="${warnInfo.warntype==7}">驶入报警</c:if> <c:if											test="${warnInfo.warntype==8}">禁停报警</c:if> <c:if											test="${warnInfo.warntype==9}">未按规定停车报警</c:if> <c:if											test="${warnInfo.warntype==10}">长时间停车报警</c:if></th>									<th>${warnInfo.createdate}</th>								</tr>							</c:forEach>						</tbody>					</table>					<div>						<input type="hidden" value="${maxId}" id="maxId">					</div>				</div>			</div>		</div>	</div>	<script type="text/javascript">		//创建和初始化地图函数：		function initMap() {			createMap();//创建地图			setMapEvent();//设置地图事件			// addMapControl();//向地图添加控件			addMapOverlay();//向地图添加覆盖物		}		function createMap() {			map = new BMap.Map("map");			map.centerAndZoom(new BMap.Point(116.403874, 39.914889), 6);		}		function setMapEvent() {			map.enableScrollWheelZoom();			map.enableKeyboard();			map.enableDragging();			map.enableDoubleClickZoom()		}		function addClickHandler(target, window) {			target.addEventListener("click", function() {				target.openInfoWindow(window);			});		}		function addMapOverlay() {		}		//向地图添加控件		function addMapControl() {			var scaleControl = new BMap.ScaleControl({				anchor : BMAP_ANCHOR_BOTTOM_LEFT			});			scaleControl.setUnit(BMAP_UNIT_IMPERIAL);			map.addControl(scaleControl);			var navControl = new BMap.NavigationControl({				anchor : BMAP_ANCHOR_TOP_LEFT,				type : BMAP_NAVIGATION_CONTROL_LARGE			});			map.addControl(navControl);			var overviewControl = new BMap.OverviewMapControl({				anchor : BMAP_ANCHOR_BOTTOM_RIGHT,				isOpen : true			});			map.addControl(overviewControl);		}		var map;		initMap();		var styleOptions = {			strokeColor : "red", //边线颜色。			fillColor : "red", //填充颜色。当参数为空时，圆形将没有填充效果。			strokeWeight : 3, //边线的宽度，以像素为单位。			strokeOpacity : 0.8, //边线透明度，取值范围0 - 1。			fillOpacity : 0.3, //填充的透明度，取值范围0 - 1。			strokeStyle : 'solid' //边线的样式，solid或dashed。		};		/*****************************************************************************/		/**作者:张中德		 */		//解析围栏信息		var crawlData = '${crawlInfo}';		console.log(crawlData);		var crawl = eval("(" + crawlData + ")");		var obj = new Dictionary();		var circleObj = new Dictionary();		var count = crawl.length;		for ( var i = 0; i < count; i++) {			var pointStr = crawl[i].circlePoint;			var s = pointStr.split(",");			var circlePlng = s[0];			var circlePlat = s[1];			var warnId = crawl[i].id;			var warnInfo;			var circle = new BMap.Circle(					new BMap.Point(circlePlng, circlePlat),					crawl[i].circleRadius, styleOptions);			circle.disableMassClear();			map.addOverlay(circle);			circle.hide();			circleObj.put(warnId, circle);			if (crawl[i].chartType == 1) {				switch (crawl[i].warnType) {				case 3:					warnInfo = crawl[i].crawlName + "&" + crawl[i].warnType							+ "&" + crawl[i].validityStart + "&"							+ crawl[i].validityEnd + "&" + crawl[i].idleTime;					break;				case 4:					warnInfo = crawl[i].crawlName + "&" + crawl[i].warnType							+ "&" + crawl[i].validityStart + "&"							+ crawl[i].validityEnd + "&" + crawl[i].parkTime;					break;				case 5:					warnInfo = crawl[i].crawlName + "&" + crawl[i].warnType							+ "&" + crawl[i].validityStart + "&"							+ crawl[i].validityEnd + "&" + crawl[i].idleTime							+ "&" + crawl[i].parkTime;					break;				default:					warnInfo = crawl[i].crawlName + "&" + crawl[i].warnType							+ "&" + crawl[i].validityStart + "&"							+ crawl[i].validityEnd;					break;				}			} else {			}			obj.put(warnId, warnInfo);					}				/************************************************************************/		//解析小车信息		//获取车辆信息判断车辆在哪种围栏范围内			var carMsgData = '${carMsgInfo}';			var carMsg1 = eval("(" + carMsgData + ")");			resolve(carMsg1);			setTimeout(function () {		        socket();		    }, 10000);		//解析小车数据		function resolve(carMsg){						if(carMsg.length > 0)				{					for ( var j = 0; j < carMsg.length; j++) {											var point = new BMap.Point(carMsg[j].longitude, carMsg[j].latitude);										var carWarnType = carMsg[j].crawlwarnId;					var label = carMsg[j].plateNumber + "<p hidden>" + carWarnType							+ "</p>";					var state = carMsg[j].state;					addMarker(point, label, state);								//isWarn(point,carMsg[j].sn,carWarnType,carMsg[j].plateNumber);				}									}					}				//判断小车是否产生报警，报警返回到后台,不报警不返回		function isWarn(point,sn, carWarnType,plateNUmber) {						var warntype = carWarnType.split(",");			for ( var i = 0; i < warntype.length; i++) {				var warninfo = obj.get(warntype[i]).split("&");				var wName = warninfo[0];				var wType = warninfo[1];				var wStart = warninfo[2];				var wEnd = warninfo[3];				var wIdleTime, wParkTime;				var result = isInTime(wStart, wEnd);				if (result) //在制定时间范围内				{					switch (wType) {					case "1": //驶出围栏					{						//判断点在圆内						if (!BMapLib.GeoUtils.isPointInCircle(point, circleObj								.get(warntype[i]))) //不在圆内						{							 $('#tb tr:eq(0)').before('<tr><th>'+plateNUmber+'</th><th>驶出报警</th></tr>');							 insertWarn(sn,6);						}					}						break;					case "2": //驶入围栏					{						//判断点在圆外						if (BMapLib.GeoUtils.isPointInCircle(point, circleObj								.get(warntype[i]))) //在圆内						{							$('#tb tr:eq(0)').before('<tr><th>'+plateNUmber+'</th><th>驶入报警</th></tr>');							insertWarn(sn,7);						}					}						break;					case "3": //禁停					{						alert("case 3");						wIdleTime = warninfo[4];					}						break;					case "4": //未按规定停车					{						wParkTime = warninfo[4];					}						break;					case "5": //长时间停车					{						wIdleTime = warninfo[4];						wParkTime = warninfo[5];					}						break;					}				}			}		}								/***************************************************************/		function socket(){			//webSocket实时刷新车辆位置信息		    var webSocket =  new WebSocket('ws://localhost:8080/motorcadeWeb/crawlCarMsgSocket');			webSocket.onerror = function(event) {				onError(event);			};			webSocket.onopen = function(event) {				onOpen(event);			};			webSocket.onmessage = function(event) {								onMessage(event);			};			function onOpen(event) {				var str = $("#crawlname").val();				var maxId = $("#maxId").val();				webSocket.send(str+"&"+maxId);			}			function onError(event) {				alert(event.data);			}						function onMessage(event) {				map.clearOverlays();				console.log(event.data);				var carMsgData = eval("("+event.data+")");				var warnDate = carMsgData.warnMsg;				resolve(carMsgData.carMsg);				$("#maxId").val(carMsgData.maxId);				if(warnDate.length > 0)					{					for ( var i = warnDate.length - 1; i < warnDate.length; i--) {						switch (warnDate[i].warntype) {						case 6:							$('#tb tr:eq(0)').before('<tr><th>'+warnDate[i].plateNumber+'</th><th>驶出报警</th><th>'+warnDate[i].createdate+'</th></tr>');							break;						case 7:							$('#tb tr:eq(0)').before('<tr><th>'+warnDate[i].plateNumber+'</th><th>驶入报警</th><th>'+warnDate[i].createdate+'</th></tr>');							break;						case 8:							$('#tb tr:eq(0)').before('<tr><th>'+warnDate[i].plateNumber+'</th><th>驶入报警</th><th>'+warnDate[i].createdate+'</th></tr>');							break;						case 9:							$('#tb tr:eq(0)').before('<tr><th>'+warnDate[i].plateNumber+'</th><th>驶入报警</th><th>'+warnDate[i].createdate+'</th></tr>');							break;						case 10:							$('#tb tr:eq(0)').before('<tr><th>'+warnDate[i].plateNumber+'</th><th>驶入报警</th><th>'+warnDate[i].createdate+'</th></tr>');							break;						default:							break;						}					}													}							}		}				//判断当前时间是否在报警时间设置内		function isInTime(startTime, endTime) {			var today = new Date();			var h = today.getHours();			var m = today.getMinutes();			var s = today.getSeconds();			m = checkTime(m);			s = checkTime(s);			var nowtime = h + ":" + m + ":" + s;			return compare_hms(startTime, nowtime, endTime);		}		/**		 *键值对，方便快速定位围栏		 */		function Dictionary() {			this.data = new Array();			this.put = function(key, value) {				this.data[key] = value;			};			this.get = function(key) {				return this.data[key];			};			this.remove = function(key) {				this.data[key] = null;			};			this.isEmpty = function() {				return this.data.length == 0;			};			this.size = function() {				return this.data.length;			};		}		//地图上显示小车信息		function addMarker(point, lable, online) {						var carMarket;			if (online == 0 || online == 3) {				carMarket = new BMap.Marker(point, {					icon : new BMap.Icon("./pages/img/caroff.png",							new BMap.Size(28, 40), {								imageOffset : new BMap.Size(0, 0)							})				});			} else if (online == 1 || online == 2) {				carMarket = new BMap.Marker(point, {					icon : new BMap.Icon("./pages/img/car.png", new BMap.Size(							28, 40), {						imageOffset : new BMap.Size(0, 0)					})				});			}			carMarket.setTop(true);			var label = new BMap.Label(lable, {				offset : new BMap.Size(-8, -25)			});			carMarket.setLabel(label);			map.addOverlay(carMarket);						//鼠标在小车上			carMarket.addEventListener("mouseover", function() {				carMarket.setTop(true, 27000000);				var p = this.getLabel();								var m = p.getContent();				var n = m.split("<p hidden>");				var warnType = n[1].substr(0, n[1].length - 4);								var s = warnType.split(",");				for ( var i = 0; i < s.length; i++) {					circleObj.get(s[i]).show();				}			});			//鼠标离开小车			carMarket.addEventListener("mouseout", function() {				carMarket.setTop(false);				var p = this.getLabel();  				var m = p.getContent();				var n = m.split("<p hidden>");				var warnType = n[1].substr(0, n[1].length - 4);								var s = warnType.split(",");				for ( var i = 0; i < s.length; i++) {					circleObj.get(s[i]).hide();				}			});					}		//判断当前是否在围栏设置时间内		function compare_hms(a, b, c) {			var d = a.split(":");			var e = b.split(":");			var f = c.split(":");			var i = parseInt(d[0]) * 60 * 60 + parseInt(d[1]) * 60					+ parseInt(d[2]);			var n = parseInt(e[0]) * 60 * 60 + parseInt(e[1]) * 60					+ parseInt(e[2]);			var g = parseInt(f[0]) * 60 * 60 + parseInt(f[1]) * 60					+ parseInt(f[2]);			if (n >= i && n <= g)				return true;			return false;		}		//设置时间格式		function checkTime(i) {			if (i < 10) {				i = "0" + i;			}			return i;		}		function trOnclick(id)		{			$("#crawlname").val(id);			$("#maxId").val(0);			$("#form").submit();		}		//向后台发送报警数据		function insertWarn(sn,warnType)		{			var param = {					"sn" : sn,					"warnType" : warnType			};			var url = "./insertCrawlWarn";			$.ajax({				type : "post",				data : param,				url : url,				success : function (result){					alert(result);				}							});		}										/*****************************************************************************/		var work_layout = document				.getElementById('manage-Monitor-right-work-wap-id');				var zTree_menu = document				.getElementById('manage-Monitor-left-menu-title-id');		function showMeaun() {			if (zTree_menu.style.display == "block") {				zTree_menu.style.display = "none";				work_layout.style.width = "100%";				$("#manage-Monitor-right-work-data-MenuDisplay-btn").html(						'》》');			} else {				zTree_menu.style.display = "block";				$("#manage-Monitor-right-work-data-MenuDisplay-btn").html(						'《《');				work_layout.style.width = "80%";			}		}		function showmenu(id) {			var list = document.getElementById("list" + id);			var menu = document.getElementById("menu" + id)			if (list.style.display == "none") {				document.getElementById("list" + id).style.display = "block";				menu.className = "title1";			} else {				document.getElementById("list" + id).style.display = "none";				menu.className = "title";			}		}				$(function () {			var pageNow = $("#pageNow").val();			var endPage = ${crawlPage.totalPageCount};			$("#first").click(function(){				if(pageNow == 1){					alert("已经是第一页了！")					return false;				}				$("#pageNow").val(1);				$("#form").submit();				return false;			})			$("#last").click(function(){				if(pageNow == 1){					alert("已经是第一页了！")					return false;				}				$("#pageNow").val(pageNow-1);				$("#form").submit();				return false;			})			$("#next").click(function(){				if(pageNow == endPage){					alert("已经是最后一页了！")					return false;				}				$("#pageNow").val(parseInt(pageNow)+1);				$("#form").submit();				return false;			})			$("#end").click(function(){				if(pageNow == endPage){					alert("已经是最后一页了！")					return false;				}				$("#pageNow").val(endPage);				$("#form").submit();				return false;			})			$("#cancel").click(function(){				if(confirm("是否确认退出当前用户?"))					window.location.href = "<%=basePath%>manager_outLogin";			});		});	</script></body></html>